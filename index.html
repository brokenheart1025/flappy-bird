<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£›ç¿”å°é³¥ (Flappy Bird)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vt323&display=swap');
        
        body {
            font-family: 'Vt323', monospace, sans-serif;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šçš„é è¨­è§¸æ§è¡Œç‚º */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #333;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .pixel-font {
            font-family: 'Vt323', monospace;
        }
    </style>
</head>
<body class="bg-gray-900 select-none">

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- UI å±¤ -->
        <div id="ui-layer" class="absolute inset-0 pointer-events-none flex flex-col items-center justify-center z-10">
            
            <!-- é–‹å§‹ç•«é¢ -->
            <div id="start-screen" class="text-center transition-opacity duration-300">
                <h1 class="text-6xl md:text-8xl text-white font-bold drop-shadow-[0_4px_0_rgba(0,0,0,1)] pixel-font mb-4 text-stroke">é£›ç¿”å°é³¥</h1>
                <div class="bg-white/90 border-4 border-black p-6 rounded-xl shadow-lg pointer-events-auto inline-block animate-bounce">
                    <p class="text-2xl text-gray-800 mb-4 font-bold">é»æ“Šè¢å¹• æˆ– æŒ‰ç©ºç™½éµ</p>
                    <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white text-3xl px-8 py-2 rounded border-b-4 border-green-700 active:border-b-0 active:mt-1 font-bold">
                        é–‹å§‹éŠæˆ²
                    </button>
                </div>
            </div>

            <!-- éŠæˆ²çµæŸç•«é¢ (éš±è—) -->
            <div id="game-over-screen" class="hidden text-center bg-black/50 p-8 rounded-2xl backdrop-blur-sm transition-all duration-300 transform scale-90 opacity-0 pointer-events-auto">
                <h2 class="text-6xl text-orange-400 font-bold drop-shadow-md mb-2 pixel-font">GAME OVER</h2>
                
                <div class="bg-[#DED895] border-4 border-[#543847] p-4 rounded-lg w-64 mx-auto mb-6 relative">
                    <p class="text-xl text-[#E58F40] font-bold uppercase tracking-wider">Score</p>
                    <p id="final-score" class="text-4xl text-white font-bold drop-shadow-[0_2px_0_rgba(0,0,0,0.5)]">0</p>
                    
                    <div class="mt-2 border-t-2 border-[#CBB968] pt-2">
                        <p class="text-sm text-[#E58F40] font-bold uppercase tracking-wider">Best</p>
                        <p id="best-score" class="text-2xl text-white font-bold drop-shadow-[0_2px_0_rgba(0,0,0,0.5)]">0</p>
                    </div>

                    <!-- çç‰Œåœ–ç¤º -->
                    <div id="medal" class="hidden absolute top-10 left-4 w-12 h-12 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-2xl">
                        ğŸ¥‡
                    </div>
                </div>

                <button id="restart-btn" class="bg-sky-400 hover:bg-sky-500 text-white text-2xl px-8 py-3 rounded border-b-4 border-sky-600 active:border-b-0 active:mt-1 font-bold shadow-lg">
                    å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>

        <!-- å³æ™‚åˆ†æ•¸é¡¯ç¤º -->
        <div id="score-display" class="absolute top-10 w-full text-center pointer-events-none hidden z-20">
            <span id="current-score" class="text-6xl text-white font-bold drop-shadow-[0_4px_0_rgba(0,0,0,1)] pixel-font">0</span>
        </div>
    </div>

    <script>
        // éŠæˆ²è¨­å®š
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const scoreDisplay = document.getElementById('score-display');
        const currentScoreEl = document.getElementById('current-score');
        const finalScoreEl = document.getElementById('final-score');
        const bestScoreEl = document.getElementById('best-score');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const medalEl = document.getElementById('medal');

        let frames = 0;
        let score = 0;
        let highScore = localStorage.getItem('flappyHighScore') || 0;
        let isGameOver = false;
        let isPlaying = false;
        let animationId;

        // éŸ¿æ‡‰å¼ç•«å¸ƒå¤§å°
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // éŠæˆ²ç‰©ä»¶é¡åˆ¥
        const bg = {
            color: '#70c5ce',
            draw: function() {
                ctx.fillStyle = this.color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç•«ä¸€äº›ç°¡å–®çš„é›²
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                for(let i = 0; i < 5; i++) {
                    let cloudX = ((frames * 0.5) + (i * 200)) % (canvas.width + 200) - 100;
                    let cloudY = canvas.height - 150 - (i % 2) * 100;
                    
                    ctx.beginPath();
                    ctx.arc(cloudX, cloudY, 30, 0, Math.PI * 2);
                    ctx.arc(cloudX + 25, cloudY - 10, 35, 0, Math.PI * 2);
                    ctx.arc(cloudX + 50, cloudY, 30, 0, Math.PI * 2);
                    ctx.fill();
                }

                // ç•«é è™•çš„åŸå¸‚å‰ªå½±
                ctx.fillStyle = "#A3D8C6";
                for(let i = 0; i < 10; i++) {
                    let buildingX = ((frames * 0.2) + (i * 150)) % (canvas.width + 100) - 50;
                    let h = 100 + (i % 3) * 50;
                    ctx.fillRect(buildingX, canvas.height - fg.h - h, 60, h);
                }
            }
        };

        const fg = {
            h: 112,
            dx: 3,
            draw: function() {
                ctx.fillStyle = '#ded895'; // åœŸå£¤æ·ºè‰²
                ctx.fillRect(0, canvas.height - this.h, canvas.width, this.h);
                
                // é ‚éƒ¨è‰çš®
                ctx.fillStyle = '#73bf2e';
                ctx.fillRect(0, canvas.height - this.h, canvas.width, 15);
                ctx.beginPath();
                ctx.moveTo(0, canvas.height - this.h + 15);
                ctx.strokeStyle = '#589520';
                ctx.lineWidth = 2;
                ctx.stroke();

                // æ»¾å‹•ç´‹ç†æ•ˆæœ
                ctx.fillStyle = '#cbb968'; // åœŸå£¤æ·±è‰²ç´‹ç†
                const patternWidth = 20;
                let offset = (frames * this.dx) % patternWidth;
                
                for(let i = -1; i < canvas.width / patternWidth + 1; i++) {
                    // ç•«æ–œç·š
                    ctx.beginPath();
                    ctx.moveTo(i * patternWidth - offset, canvas.height - this.h + 20);
                    ctx.lineTo(i * patternWidth - offset - 10, canvas.height - 10);
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            },
            update: function() {
                // è¦–è¦ºæ»¾å‹•
            }
        };

        const bird = {
            x: 50,
            y: 150,
            radius: 12,
            velocity: 0,
            gravity: 0.25,
            jump: 4.6,
            
            draw: function() {
                let birdCenterY = this.y;
                let birdCenterX = this.x;

                ctx.save();
                ctx.translate(birdCenterX, birdCenterY);
                let rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                if(!isPlaying) rotation = 0;
                ctx.rotate(rotation);

                // èº«é«”
                ctx.fillStyle = "#FFD700"; // é»ƒè‰²
                ctx.beginPath();
                ctx.ellipse(0, 0, this.radius + 5, this.radius, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#000";
                ctx.stroke();

                // çœ¼ç›
                ctx.fillStyle = "#FFF";
                ctx.beginPath();
                ctx.arc(6, -6, 6, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
                
                // ç³å­”
                ctx.fillStyle = "#000";
                ctx.beginPath();
                ctx.arc(8, -6, 2, 0, Math.PI*2);
                ctx.fill();

                // å˜´å·´
                ctx.fillStyle = "#FFA500";
                ctx.beginPath();
                ctx.moveTo(6, 2);
                ctx.lineTo(16, 6);
                ctx.lineTo(6, 10);
                ctx.fill();
                ctx.stroke();

                // ç¿…è†€
                ctx.fillStyle = "#F0E68C";
                ctx.beginPath();
                let wingY = (Math.floor(frames / 5) % 2 === 0) ? 2 : -2;
                ctx.ellipse(-5, 2 + wingY, 8, 5, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();

                ctx.restore();
            },
            
            flap: function() {
                this.velocity = -this.jump;
            },
            
            update: function() {
                this.velocity += this.gravity;
                this.y += this.velocity;

                // åœ°æ¿ç¢°æ’
                if (this.y + this.radius >= canvas.height - fg.h) {
                    this.y = canvas.height - fg.h - this.radius;
                    gameOver();
                }

                // å¤©èŠ±æ¿ç¢°æ’
                if (this.y - this.radius <= 0) {
                    this.y = this.radius;
                    this.velocity = 0;
                }
            },
            
            reset: function() {
                this.y = canvas.height / 2;
                this.velocity = 0;
                this.x = canvas.width / 4; 
            }
        };

        const pipes = {
            position: [],
            w: 52,
            gap: 130, // ç¨å¾®åŠ å¤§é–“è·ï¼Œå› ç‚ºç¾åœ¨æœ‰ä¸Šä¸‹å…©æ ¹
            dx: 3, 
            
            draw: function() {
                for(let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    let topY = p.y; // ä¸Šç®¡çš„é«˜åº¦
                    let bottomY = p.y + this.gap; // ä¸‹ç®¡çš„é–‹å§‹ Y åº§æ¨™ (ä¸Šç®¡é•·åº¦ + é–“è·)
                    
                    // --- ä¸Šæ–¹æ°´ç®¡ ---
                    ctx.fillStyle = '#73bf2e';
                    ctx.fillRect(p.x, 0, this.w, topY);
                    
                    // ä¸Šæ–¹æ°´ç®¡å£
                    ctx.fillStyle = '#73bf2e';
                    ctx.fillRect(p.x - 2, topY - 20, this.w + 4, 20);
                    ctx.strokeRect(p.x - 2, topY - 20, this.w + 4, 20);
                    ctx.strokeRect(p.x, 0, this.w, topY);

                    // --- ä¸‹æ–¹æ°´ç®¡ ---
                    // å¾ bottomY ç•«åˆ°åœ°æ¿ä¸Šæ–¹
                    let bottomPipeHeight = canvas.height - bottomY - fg.h;
                    
                    ctx.fillStyle = '#73bf2e';
                    ctx.fillRect(p.x, bottomY, this.w, bottomPipeHeight);
                    
                    // ä¸‹æ–¹æ°´ç®¡å£
                    ctx.fillStyle = '#73bf2e';
                    ctx.fillRect(p.x - 2, bottomY, this.w + 4, 20);
                    ctx.strokeRect(p.x - 2, bottomY, this.w + 4, 20);
                    ctx.strokeRect(p.x, bottomY, this.w, bottomPipeHeight);
                }
            },
            
            update: function() {
                // æ¯ 100 å¹€ç”Ÿæˆä¸€å€‹æ–°æ°´ç®¡
                if (frames % 100 === 0) {
                    // è¨ˆç®—å¯ç”¨çš„å‚ç›´ç©ºé–“
                    let availableHeight = canvas.height - fg.h;
                    // æœ€å°æ°´ç®¡é«˜åº¦ (é¿å…æ°´ç®¡å¤ªçŸ­)
                    let minPipeHeight = 50;
                    // æœ€å¤§ä¸Šç®¡é•·åº¦ = ç¸½é«˜åº¦ - æœ€å°ä¸‹ç®¡é«˜åº¦ - é–“è·
                    let maxTopHeight = availableHeight - minPipeHeight - this.gap;
                    
                    // éš¨æ©Ÿç”Ÿæˆä¸Šç®¡é•·åº¦
                    let randomY = Math.floor(Math.random() * (maxTopHeight - minPipeHeight + 1)) + minPipeHeight;

                    this.position.push({
                        x: canvas.width,
                        y: randomY,
                        passed: false
                    });
                }

                for(let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    p.x -= this.dx;

                    // ç¢°æ’æª¢æ¸¬
                    let birdLeft = bird.x - bird.radius + 5;
                    let birdRight = bird.x + bird.radius - 5;
                    let birdTop = bird.y - bird.radius + 5;
                    let birdBottom = bird.y + bird.radius - 5;

                    let pipeLeft = p.x;
                    let pipeRight = p.x + this.w;
                    
                    let topPipeBottomY = p.y;
                    let bottomPipeTopY = p.y + this.gap;

                    // é€²å…¥æ°´ç®¡çš„ X ç¯„åœ
                    if (birdRight > pipeLeft && birdLeft < pipeRight) {
                        // æ’åˆ°ä¸Šç®¡ (é³¥çš„é ‚éƒ¨ < ä¸Šç®¡åº•éƒ¨) OR æ’åˆ°ä¸‹ç®¡ (é³¥çš„åº•éƒ¨ > ä¸‹ç®¡é ‚éƒ¨)
                        if (birdTop < topPipeBottomY || birdBottom > bottomPipeTopY) {
                            gameOver();
                        }
                    }

                    // åŠ åˆ†
                    if(p.x + this.w < bird.x && !p.passed) {
                        score++;
                        scoreDisplay.classList.remove('scale-150');
                        void scoreDisplay.offsetWidth; 
                        scoreDisplay.classList.add('scale-125');
                        setTimeout(() => scoreDisplay.classList.remove('scale-125'), 100);
                        
                        currentScoreEl.innerText = score;
                        p.passed = true;
                        
                        if(score % 10 === 0) this.dx += 0.2;
                    }

                    // ç§»é™¤è¶…å‡ºç•«é¢çš„æ°´ç®¡
                    if(p.x + this.w <= 0) {
                        this.position.shift();
                        i--;
                    }
                }
            },
            
            reset: function() {
                this.position = [];
                this.dx = 3;
            }
        };

        // éŠæˆ²æ§åˆ¶
        function init() {
            bird.reset();
            pipes.reset();
            score = 0;
            frames = 0;
            currentScoreEl.innerText = score;
            isGameOver = false;
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameOverScreen.classList.remove('flex', 'scale-100', 'opacity-100');
            gameOverScreen.classList.add('scale-90', 'opacity-0');
            
            scoreDisplay.classList.remove('hidden');
            isPlaying = true;
            loop();
        }

        function loop() {
            // èƒŒæ™¯å§‹çµ‚ç¹ªè£½
            bg.draw();
            
            if (isPlaying) {
                pipes.update();
                pipes.draw();
                
                fg.update();
                fg.draw();
                
                bird.update();
                bird.draw();
                
                frames++;
                animationId = requestAnimationFrame(loop);
            }
        }

        function gameOver() {
            isPlaying = false;
            isGameOver = true;
            cancelAnimationFrame(animationId);
            
            bg.draw();
            pipes.draw();
            fg.draw();
            bird.draw();

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('flappyHighScore', highScore);
                medalEl.classList.remove('hidden');
                medalEl.style.backgroundColor = '#FFD700'; 
                medalEl.innerHTML = 'ğŸ¥‡';
            } else if (score >= 10) {
                medalEl.classList.remove('hidden');
                medalEl.style.backgroundColor = '#C0C0C0'; 
                medalEl.innerHTML = 'ğŸ¥ˆ';
            } else {
                medalEl.classList.add('hidden');
            }

            finalScoreEl.innerText = score;
            bestScoreEl.innerText = highScore;

            scoreDisplay.classList.add('hidden');
            
            gameOverScreen.classList.remove('hidden', 'scale-90', 'opacity-0');
            gameOverScreen.classList.add('flex', 'flex-col', 'scale-100', 'opacity-100');
        }

        function inputHandler(e) {
            if (e.type === 'keydown' && e.code !== 'Space') return;
            if (e.type === 'touchstart') e.preventDefault(); 

            if (!isPlaying && !isGameOver && !startScreen.classList.contains('hidden')) {
            } else if (isPlaying) {
                bird.flap();
            } else if (isGameOver) {
            }
        }

        window.addEventListener('keydown', inputHandler);
        window.addEventListener('touchstart', inputHandler, {passive: false});
        window.addEventListener('mousedown', function(e) {
            if(isPlaying) bird.flap();
        });

        startBtn.addEventListener('click', init);
        restartBtn.addEventListener('click', init);

        bg.draw();
        fg.draw();
        
        let tempY = bird.y;
        bird.y = canvas.height / 2;
        bird.x = canvas.width / 2;
        bird.draw();
        bird.y = tempY; 
        bird.x = 50; 

    </script>
</body>
</html>